# Author Feature Implementation Plan
## PTA Volunteer Sign-Up Sheets Plugin

---

## Goal Description

Add an "Author" feature to track sheet ownership, enabling:
- New "Signup Sheet Author" WordPress user role (can create and manage only their own sheets)
- Admins and Sheet Managers continue managing all sheets (via `manage_others_signup_sheets` capability)
- Future "Front End Submissions" extension support (public users identified by email only)

---

## Database Changes

**New Columns in `pta_sus_sheets` table:**
- `author_id` (INT) - WordPress user ID (0 for no author/guest authors)
- `author_email` (VARCHAR) - Author email address (for guest authors or as backup)

**Author ID Values:**
- `0` = No author assigned (legacy sheets from before upgrade) OR guest author (has email but no user ID)
- `> 0` = WordPress user ID of the author
- Distinction: Check `author_email` field - if empty, it's a legacy sheet; if set, it's a guest author

**New User Role:**
- "Signup Sheet Author" - Can create and manage only their own sheets

**New Capability:**
- `manage_others_signup_sheets` - Allows viewing/editing sheets created by other users
  - Automatically granted to: Administrator, Signup Sheet Manager
  - NOT granted to: Signup Sheet Author

---

## Implementation Tasks

### 1. Database & Activation Updates

**File: `classes/class-pta_sus_activation.php`**

#### 1.1 Update `activate_site()` method:
- Add `author_id` and `author_email` columns to table creation SQL
- Add `manage_others_signup_sheets` capability to Administrator and Signup Sheet Manager roles
- Create "Signup Sheet Author" role with:
  - `read` capability
  - `manage_signup_sheets` capability
  - NOT `manage_others_signup_sheets` capability

#### 1.2 Add upgrade function:
- Create `upgrade_to_6_1_0()` method (or similar version-based name)
- Check if columns exist before adding (use `$wpdb->get_results("SHOW COLUMNS...")`)
- Add columns if missing:
  ```sql
  ALTER TABLE {$table} ADD COLUMN author_id INT NOT NULL DEFAULT 0;
  ALTER TABLE {$table} ADD COLUMN author_email VARCHAR(100) NOT NULL DEFAULT '';
  ```
- Add index on `author_id` for performance: `KEY author_id (author_id)`
- Set existing sheets to `author_id = 0` and `author_email = ''` (legacy sheets)
- Add `manage_others_signup_sheets` capability to existing Administrator and Signup Sheet Manager roles
- Create "Signup Sheet Author" role if it doesn't exist
- Update database version to new version

#### 1.3 Update main plugin init:
- Modify `pta-volunteer-sign-up-sheets.php` `init()` method to call upgrade function if needed
- Or add upgrade check in `activate_site()` that calls version-specific upgrade functions

**Note:** Consider creating a helper class `PTA_SUS_Upgrader` for future upgrades, or add upgrade methods to Activation class.

---

### 2. Model Class Updates

**File: `classes/models/class-pta-sus-sheet.php`**

#### 2.1 Update `get_property_definitions()`:
Add:
- `'author_id' => 'int'`
- `'author_email' => 'text'`

#### 2.2 Update `get_property_defaults()`:
Add:
- `'author_id' => 0`
- `'author_email' => ''`

---

### 3. Helper Class Refactoring

**File: `classes/class-pta_sus_sheet_functions.php`**

#### 3.1 Refactor `get_sheets()` method:
- Convert parameters to `$args` array
- Call `self::get_sheets_by_args($args)`
- Maintain backward compatibility

#### 3.2 Add `get_sheets_by_args($args = array())` method:
- Parse `$args` with defaults:
  - `trash => false`
  - `active_only => false`
  - `show_hidden => false`
  - `order_by => 'first_date'`
  - `order => 'ASC'`
  - `author_id => null` (null = no filter, 0 = no author, >0 = specific author)
  - `author_email => ''` (empty = no filter)
  - `sus_group => ''` (empty = no filter, string or array for filtering)

- Build SQL query with WHERE clauses:
  - If `author_id !== null`: Add `AND author_id = %d`
  - If `author_email !== ''`: Add `AND author_email = %s`
  - Handle `sus_group` filtering (serialized array - use LIKE queries or fetch-and-filter)

- Return array of `PTA_SUS_Sheet` objects

**Performance Note:** Add database index on `author_id` column for faster queries.

---

### 4. Public Display Updates

**File: `classes/class-pta_sus_public_display_functions.php`**

#### 4.1 Update `display_sheet()` method (or equivalent):
- Add `author` to default shortcode attributes
- If `author` attribute is set, add to `$args` array
- Replace `PTA_SUS_Sheet_Functions::get_sheets()` call with `PTA_SUS_Sheet_Functions::get_sheets_by_args($args)`
- Ensure `$args` includes all necessary parameters:
  - `trash => false`
  - `active_only => true`
  - `show_hidden => self::$show_hidden`
  - `order_by => $order_by`
  - `order => $order`
  - `author_id => $author_id` (if provided)
  - `author_email => $author_email` (if provided)

**Important:** Frontend should NOT filter by author unless explicitly requested via shortcode attribute. All sheets should be visible to public users regardless of author.

---

### 5. Admin Interface Updates

**File: `classes/class-pta_sus_admin.php`**

#### 5.1 Update `admin_modify_sheet_page()` method:

**For NEW sheets:**
- Set `author_id` to current user ID: `get_current_user_id()`
- Set `author_email` to current user email: `wp_get_current_user()->user_email`

**For EDITING sheets:**
- Check if user has `manage_others_signup_sheets` capability:
  - **YES:** Show Author dropdown (to reassign) and Email field (editable)
    - Dropdown: List all users with `manage_signup_sheets` capability
    - Option for "No Author" (0)
    - Email field: Editable text input
  - **NO:** 
    - Verify current user is the author (`$sheet->author_id == get_current_user_id()`)
    - If NOT author: Deny access with error message
    - If IS author: Show read-only Author info (display only, no editing)

**Display Logic:**
- Author field section should be:
  - Visible to: Administrators, Signup Sheet Managers (editable)
  - Visible to: Signup Sheet Authors (read-only, only for their own sheets)
  - Hidden to: Others (access denied)

#### 5.2 Update sheet form processing:
- In form processing code (where `pta_sus_add_sheet()` or `pta_sus_update_sheet()` is called):
  - For new sheets: Automatically set `author_id` and `author_email` from current user
  - For updates: 
    - If user has `manage_others_signup_sheets`: Save `author_id` and `author_email` from form
    - If user does NOT have `manage_others_signup_sheets`: Only allow saving if they are the author (verify before save)

#### 5.3 Update `admin_sheet_page()` (list view):
- **IMPORTANT:** Signup Sheet Authors should ONLY see their own sheets in the list
- Check if current user has `manage_others_signup_sheets` capability
- If NO (Signup Sheet Author): 
  - Filter sheets by `author_id = get_current_user_id()`
  - This reduces list size significantly on sites with many sheets
  - Improves performance and usability for Authors
- If YES (Admin/Sheet Manager): Show all sheets (no filter)
- Pass appropriate `author_id` parameter to `PTA_SUS_Sheet_Functions::get_sheets_by_args()`

---

### 6. List Table Updates

**File: `classes/list-table.php`**

#### 6.1 Update `prepare_items()` method:
- **IMPORTANT:** Signup Sheet Authors should ONLY see their own sheets
- Check if current user has `manage_others_signup_sheets` capability
- If NO (Signup Sheet Author): 
  - Add `author_id => get_current_user_id()` to query args
  - This ensures Authors only see sheets they created
  - Reduces database query load and improves list performance
- If YES (Admin/Sheet Manager): Don't filter by author (show all sheets)
- Pass args to `PTA_SUS_Sheet_Functions::get_sheets_by_args()`

#### 6.2 Update `column_title()` method (or action column):
- Ensure "Edit", "Delete", etc. actions are only shown if:
  - User has `manage_others_signup_sheets` OR
  - User is the author of the sheet (`$sheet->author_id == get_current_user_id()`)
- This provides extra security even though list filtering should handle visibility

---

### 7. Additional Considerations

#### 7.1 Copy/Duplicate Sheets:
- When copying a sheet, set `author_id` to current user ID (new author)
- Set `author_email` to current user email

#### 7.2 Bulk Operations:
- Bulk actions should respect author permissions
- Only allow bulk actions on sheets the user can manage

#### 7.3 Export Functionality:
- Exports should respect author filtering (if user doesn't have `manage_others_signup_sheets`)

#### 7.4 Future Front-End Submissions:
- Guest authors (no user ID) will have:
  - `author_id = 0`
  - `author_email = [submitted email]`
- These sheets should be manageable by the email owner (future implementation)

---

## Verification Plan

### Automated Tests
None existing - manual testing required.

### Manual Verification Checklist

#### Upgrade Test:
- [ ] Update plugin without deactivating
- [ ] Verify `pta_sus_sheets` table has new columns (`author_id`, `author_email`)
- [ ] Verify database index exists on `author_id`
- [ ] Verify existing sheets have `author_id = 0` and `author_email = ''`
- [ ] Verify "Signup Sheet Author" role exists
- [ ] Verify Administrator has `manage_others_signup_sheets` capability
- [ ] Verify Signup Sheet Manager has `manage_others_signup_sheets` capability
- [ ] Verify Signup Sheet Author does NOT have `manage_others_signup_sheets` capability

#### Role Test (Signup Sheet Author):
- [ ] Create new user with "Signup Sheet Author" role
- [ ] Log in as this user
- [ ] Go to "Sign-up Sheets" list page - verify they see NO sheets (initially empty list)
- [ ] Create a new sheet - verify it saves with their user ID and email
- [ ] Verify they can see and edit this sheet in the list
- [ ] Log in as Admin, create multiple sheets (test with 5-10 sheets)
- [ ] Log back in as Author - verify they CANNOT see any Admin's sheets in the list
- [ ] Verify Author only sees their own sheet(s) in the list
- [ ] Verify Author cannot access Admin's sheet via direct URL (should get permission denied)
- [ ] **Performance Test:** On a site with 100+ sheets, verify Author list loads quickly (only showing their own sheets)

#### Admin Test:
- [ ] Log in as Administrator
- [ ] Verify Admin sees ALL sheets (Author's and their own)
- [ ] Edit Author's sheet - verify Author dropdown and Email field are visible and editable
- [ ] Change Author to Admin - save sheet
- [ ] Log in as Author - verify they can no longer see the sheet
- [ ] Verify Admin can assign "No Author" (0) to a sheet
- [ ] Verify Admin can assign a sheet to any user with `manage_signup_sheets` capability

#### Permission Test:
- [ ] Verify Signup Sheet Manager can see and edit all sheets
- [ ] Verify Signup Sheet Author can only see/edit their own sheets
- [ ] Verify Signup Sheet Author cannot edit another Author's sheet (even via direct URL)

#### Frontend Test:
- [ ] Verify all sheets are visible on frontend regardless of author
- [ ] Verify shortcode `[pta_signup_sheet author="user_id"]` filters correctly (if implemented)
- [ ] Verify public users can sign up for sheets regardless of author

#### Copy/Duplicate Test:
- [ ] Copy a sheet as Admin - verify new sheet has Admin as author
- [ ] Copy a sheet as Author - verify new sheet has Author as author
- [ ] Copy another Author's sheet as Admin - verify new sheet has Admin as author

---

## Phase 2: Email Template Consolidation

*(Separate implementation - to be addressed after Phase 1 is complete)*

---

## Notes & Decisions

### Author ID Default Value:
- **Decision:** Use `0` for both legacy sheets and guest authors
- **Rationale:** Simpler queries, no NULL handling needed
- **Distinction:** Check `author_email` field:
  - Empty = legacy sheet (no author)
  - Set = guest author (has email but no user ID)

### Upgrade Strategy:
- **Decision:** Add upgrade function to Activation class
- **Rationale:** Keeps upgrade logic with activation, easier to maintain
- **Alternative considered:** Separate `PTA_SUS_Upgrader` class (can be refactored later if needed)

### Admin Author Assignment:
- **Decision:** Only Administrators and Signup Sheet Managers can assign/reassign authors
- **Rationale:** Prevents authors from reassigning ownership
- **Implementation:** Author field is editable only for users with `manage_others_signup_sheets` capability

---

## Version Information

- **Target Plugin Version:** 6.1.0 (or next version after 6.0.0)
- **Database Version:** Update from 5.2.0 to new version (e.g., 6.1.0)
- **Minimum WordPress Version:** (check current requirements)
- **PHP Version:** (check current requirements)

---

**Last Updated:** [Date]
**Status:** Ready for Implementation
