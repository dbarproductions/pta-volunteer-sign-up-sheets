window.ptaVolunteer={config:{ajaxUrl:"",method:"POST",extraData:{},minSearchLength:2,debounceDelay:300},init(e={}){this.config={...this.config,...e},document.querySelector('input[name="signup_firstname"], input[name="signup_lastname"]')&&this.setupAutocomplete()},htmlDecode(e){if(!e)return"";const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""},setupAutocomplete(){document.querySelectorAll('input[name="signup_firstname"], input[name="signup_lastname"], input[name="signup_email"]').forEach(e=>{let t,n;e.addEventListener("input",a=>{const r=a.target.value.trim();clearTimeout(t),n&&n.abort(),r.length<this.config.minSearchLength?this.clearAutocomplete(e):t=setTimeout(async()=>{try{n=new AbortController;const t=await this.fetchResults(r,n.signal);this.renderAutocomplete(t,e)}catch(t){"AbortError"!==t.name&&this.clearAutocomplete(e)}finally{n=null}},this.config.debounceDelay)}),e.addEventListener("blur",()=>{setTimeout(()=>{this.clearAutocomplete(e)},200)})})},async fetchResults(e,t){const n=new FormData;n.append("q",e),n.append("pta_pub_action","autocomplete_volunteer"),n.append("action",this.config.extraData.action),n.append("security",this.config.extraData.security);const a=await fetch(this.config.ajaxUrl,{method:"POST",body:n,signal:t});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=await a.json();return r&&"object"==typeof r&&"success"in r?r.success&&Array.isArray(r.data)?r.data:[]:Array.isArray(r)?r:[]},renderAutocomplete(e,t){let n=t.parentNode.querySelector(".autocomplete-results");if(n||(n=document.createElement("ul"),n.className="autocomplete-results",t.parentNode.appendChild(n)),!e||!Array.isArray(e)||0===e.length)return n.innerHTML="",void(n.style.display="none");n._volunteerData||(n._volunteerData=[]),n._volunteerData=e,n.style.display="block",n.innerHTML=e.map((e,t)=>`\n                <li>\n                    <a href="#" data-index="${t}">\n                        <strong>${this.htmlDecode(e.firstname||"")} ${this.htmlDecode(e.lastname||"")}</strong>\n                        <br>\n                        <small>${this.htmlDecode(e.email||"")}</small>\n                    </a>\n                </li>\n            `).join(""),n.removeEventListener("click",n._clickHandler),n._clickHandler=e=>{e.preventDefault(),e.stopPropagation();const a=e.target.closest("a[data-index]");if(a&&n._volunteerData){const e=parseInt(a.getAttribute("data-index"),10);!isNaN(e)&&n._volunteerData[e]&&(this.populateFields(n._volunteerData[e]),this.clearAutocomplete(t))}},n.addEventListener("click",n._clickHandler)},clearAutocomplete(e){const t=e.parentNode.querySelector(".autocomplete-results");t&&(t.innerHTML="",t.style.display="none",t._volunteerData&&(t._volunteerData=null),t._clickHandler&&(t.removeEventListener("click",t._clickHandler),t._clickHandler=null))},populateFields(e){if(!e||"object"!=typeof e)return;Object.keys(e).forEach(t=>{const n=document.querySelector(`input[name="signup_${t}"]`)||document.querySelector(`input[name="${t}"]`);n&&(n.value=this.htmlDecode(e[t]))});const t=document.querySelector('input[name="signup_validate_email"]');t&&(t.value=this.htmlDecode(e.email||""))}};