window.ptaVolunteer={config:{ajaxUrl:"",method:"POST",extraData:{},minSearchLength:2,debounceDelay:300},init(e={}){this.config={...this.config,...e},document.querySelector('input[name="signup_firstname"], input[name="signup_lastname"]')&&this.setupAutocomplete()},htmlDecode(e){if(!e)return"";const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""},setupAutocomplete(){document.querySelectorAll('input[name="signup_firstname"], input[name="signup_lastname"], input[name="signup_email"]').forEach(e=>{let t,n;e.addEventListener("input",a=>{const o=a.target.value.trim();clearTimeout(t),n&&n.abort(),o.length<this.config.minSearchLength?this.clearAutocomplete(e):t=setTimeout(async()=>{try{n=new AbortController;const t=await this.fetchResults(o,n.signal);this.renderAutocomplete(t,e)}catch(t){"AbortError"!==t.name&&this.clearAutocomplete(e)}finally{n=null}},this.config.debounceDelay)}),e.addEventListener("blur",()=>{setTimeout(()=>{this.clearAutocomplete(e)},200)})})},async fetchResults(e,t){const n=new FormData;n.append("q",e),n.append("pta_pub_action","autocomplete_volunteer"),n.append("action",this.config.extraData.action),n.append("security",this.config.extraData.security);const a=await fetch(this.config.ajaxUrl,{method:"POST",body:n,signal:t});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.json();return o&&"object"==typeof o&&"success"in o?o.success&&Array.isArray(o.data)?o.data:[]:Array.isArray(o)?o:[]},renderAutocomplete(e,t){let n=t.parentNode.querySelector(".autocomplete-results");if(n||(n=document.createElement("ul"),n.className="autocomplete-results",t.parentNode.appendChild(n),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const n=e.target.closest("a[data-volunteer]");if(n)try{const e=JSON.parse(n.dataset.volunteer);this.populateFields(e),this.clearAutocomplete(t)}catch(e){}})),!e||!Array.isArray(e)||0===e.length)return n.innerHTML="",void(n.style.display="none");n.style.display="block",n.innerHTML=e.map(e=>{const t=this.htmlDecode(e.firstname||""),n=this.htmlDecode(e.lastname||""),a=this.htmlDecode(e.email||"");return`\n                <li>\n                    <a href="#" data-volunteer="${JSON.stringify(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}">\n                        <strong>${t} ${n}</strong>\n                        <br>\n                        <small>${a}</small>\n                    </a>\n                </li>\n            `}).join("")},clearAutocomplete(e){const t=e.parentNode.querySelector(".autocomplete-results");t&&(t.innerHTML="",t.style.display="none")},populateFields(e){if(!e||"object"!=typeof e)return;Object.keys(e).forEach(t=>{const n=document.querySelector(`input[name="signup_${t}"]`)||document.querySelector(`input[name="${t}"]`);n&&(n.value=this.htmlDecode(e[t]))});const t=document.querySelector('input[name="signup_validate_email"]');t&&(t.value=this.htmlDecode(e.email||""))}};