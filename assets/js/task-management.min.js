!function(t){"use strict";var a={modal:null,hasUnsavedChanges:!1,originalFormData:null,sheetId:0,sheetType:"",noSignups:!1,originalDates:{},datesChanged:!1,init:function(){t(".pta-sus-task-management").length&&(this.sheetId=ptaSusTaskData.sheetId,this.sheetType=ptaSusTaskData.sheetType,this.noSignups=ptaSusTaskData.noSignups,this.storeOriginalDates(),this.initModal(),this.initEventHandlers(),this.initDragDrop(),this.initDateChangeTracking())},initModal:function(){var a=this;this.modal=t("#pta-sus-task-modal").dialog({autoOpen:!1,modal:!0,width:900,height:"auto",maxHeight:.9*t(window).height(),resizable:!0,draggable:!0,closeOnEscape:!0,beforeClose:function(t,e){return a.handleModalClose()},open:function(t,e){setTimeout(function(){a.initFormPlugins(),a.initEmailTemplatesToggle()},100)},close:function(a,e){var s=t("#task_description-quill-container");if(s.length){var i=s.data("quill-instance");i&&i.root&&t("#task_description").val(i.root.innerHTML)}}}),this.initFormPlugins()},initFormPlugins:function(){t("#pta-sus-task-modal .pta-timepicker").timepicker({showPeriod:!0,showLeadingZero:!0,defaultTime:""}),t("#pta-sus-task-modal .singlePicker").datepick({pickerClass:"pta",monthsToShow:1,dateFormat:"yyyy-mm-dd",showTrigger:"#calImg"}),void 0!==t.fn.select2&&t("#pta-sus-task-modal select.jq-select2:not(.select2-hidden-accessible), #pta-sus-task-modal select[multiple]:not(.select2-hidden-accessible)").select2({width:"100%"}),this.initQuillEditor(),this.initCustomFieldsQuillEditors(),t("#pta-sus-task-modal").off("change",".details_checkbox").on("change",".details_checkbox",function(){t("#pta-sus-task-modal .pta_toggle").toggle(this.checked)}),t("#pta-sus-task-form").off("change input","input, select, textarea").on("change input","input, select, textarea",function(){a.hasUnsavedChanges=!0})},initEmailTemplatesToggle:function(){var a=t("#pta-sus-task-modal .task_email_templates_trigger");a.length&&a.off("click").on("click",function(a){a.preventDefault();var e=t("#pta-sus-task-modal .pta_sus_task_email_templates");e.length&&(e.is(":visible")?e.hide():e.show())})},initQuillEditor:function(){if("undefined"!=typeof Quill){var e=t("#task_description-quill-container"),s=t("#task_description");if(e.length&&s.length&&!e.data("quill-instance")){var i=s.val()||"",n=new Quill(e[0],{theme:"snow",modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],["blockquote","code-block"],["link"],["clean"]],clipboard:{matchVisual:!1}}});if(i){var l=n.clipboard.convert({html:i});n.setContents(l,"silent")}n.on("text-change",function(){s.val(n.root.innerHTML),a.hasUnsavedChanges=!0});var o=n.getModule("toolbar");o&&o.addHandler("link",function(t){if(t){var a=prompt("Enter the URL:");a?n.format("link",a):n.format("link",!1)}else n.format("link",!1)}),e.data("quill-instance",n)}}},initCustomFieldsQuillEditors:function(){"undefined"!=typeof Quill&&t("#pta-sus-task-modal .pta-quill-container").each(function(){var e=t(this),s=e.attr("id");if("task_description-quill-container"!==s&&!e.data("quill-instance")&&s&&-1!==s.indexOf("-quill-container")){var i=s.replace("-quill-container",""),n=t("#"+i);if(n.length){var l=new Quill(e[0],{theme:"snow",modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],["blockquote","code-block"],["link"],["clean"]],clipboard:{matchVisual:!1}}}),o=n.val()||"";if(o){var r=l.clipboard.convert({html:o});l.setContents(r,"silent")}else l.setContents([],"silent");l.on("text-change",function(){n.val(l.root.innerHTML),a.hasUnsavedChanges=!0});var d=l.getModule("toolbar");d&&d.addHandler("link",function(t){if(t){var a=prompt("Enter the URL:");a?l.format("link",a):l.format("link",!1)}else l.format("link",!1)}),e.data("quill-instance",l)}}})},initEventHandlers:function(){var a=this;t("#pta-sus-add-new-task").on("click",function(){a.openModalForNewTask()}),t("#pta-sus-add-copy-task").on("click",function(){var e=t("#pta-sus-copy-task-select").val();e>0?a.openModalForCopy(e):a.openModalForNewTask()}),t(document).on("click",".pta-sus-edit-task",function(){var e=t(this).data("task-id");a.openModalForEdit(e)}),t(document).on("click",".pta-sus-copy-task",function(){var e=t(this).data("task-id");a.openModalForCopy(e)}),t(document).on("click",".pta-sus-delete-task",function(){var e=t(this).data("task-id");a.deleteTask(e)}),t("#pta-sus-task-save").on("click",function(){a.saveTask()}),t("#pta-sus-task-cancel").on("click",function(){a.closeModal()}),t("#pta-sus-save-order").on("click",function(){a.saveTaskOrder()}),t("#pta-sus-save-dates").on("click",function(){a.saveSheetDates()})},storeOriginalDates:function(){"Single"===this.sheetType?this.originalDates.single=t("#single_date").val()||"":"Recurring"===this.sheetType&&(this.originalDates.recurring=t("#multi999Picker").val()||"")},initDateChangeTracking:function(){var a=this;if("Single"===this.sheetType){var e=t("#single_date");e.prop("readonly")?e.data("datepick-initialized")&&(e.datepick("destroy"),e.removeData("datepick-initialized")):(e.data("datepick-initialized")||(e.datepick({pickerClass:"pta",monthsToShow:1,dateFormat:"yyyy-mm-dd",showTrigger:"#calImg"}),e.data("datepick-initialized",!0)),e.on("change",function(){a.checkDateChanges()}))}else"Recurring"===this.sheetType&&t("#multi999Picker").on("change",function(){a.checkDateChanges()})},checkDateChanges:function(){var a=!1;if("Single"===this.sheetType)a=(t("#single_date").val()||"")!==this.originalDates.single;else if("Recurring"===this.sheetType){a=(t("#multi999Picker").val()||"")!==this.originalDates.recurring}this.datesChanged=a,this.updateDateChangeIndicator()},updateDateChangeIndicator:function(){var a=t("#pta-sus-save-dates"),e=t(".pta-sus-sheet-dates-section");this.datesChanged?(e.find(".dates-changed-indicator").length||a.after('<span class="dates-changed-indicator" style="color: #d63638; margin-left: 10px; font-weight: bold;">*</span>'),a.removeClass("button-secondary").addClass("button-primary")):e.find(".dates-changed-indicator").remove()},initDragDrop:function(){var a=t("#pta-sus-task-list-body");a.length&&a.sortable({handle:".column-drag",axis:"y",opacity:.6,cursor:"move",update:function(a,e){t("#pta-sus-save-order").prop("disabled",!1).text("Save Order"),t("#pta-sus-save-order-container").show()}})},openModalForNewTask:function(){if("Single"===this.sheetType||"Recurring"===this.sheetType){var a=!1;if("Single"===this.sheetType){var e=t("#single_date").val();a=e&&""!==e.trim()}else if("Recurring"===this.sheetType){var s=t("#multi999Picker").val();a=s&&""!==s.trim()}if(!a){var i="Single"===this.sheetType?"date":"dates";this.sheetType;if(!confirm("Please set "+i+' for this sheet before adding tasks.\n\nClick "Cancel" to set '+i+' first, or "OK" to continue anyway (you will need to set '+i+" before saving the task)."))return void("Single"===this.sheetType?t("#single_date").focus():t("#multi999Picker").focus())}}this.resetForm(),this.setModalTitle("Add New Task"),t("#task_id").val(0),this.hasUnsavedChanges=!1,this.originalFormData=this.getFormData(),this.modal.dialog("open")},openModalForEdit:function(a){var e=this;this.modal.dialog("open"),this.setModalTitle("Loading...");var s=t("#pta-sus-task-form");s.css("opacity","0.5").css("pointer-events","none"),t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:{action:"pta_sus_get_task",nonce:ptaSusTaskData.nonce,task_id:a},success:function(a){s.css("opacity","1").css("pointer-events","auto"),a.success&&a.data.task?(e.resetForm(),e.populateForm(a.data.task),e.setModalTitle("Edit Task"),e.hasUnsavedChanges=!1,setTimeout(function(){void 0!==t.fn.select2&&t("#pta-sus-task-modal select.jq-select2:not(.select2-hidden-accessible), #pta-sus-task-modal select[multiple]:not(.select2-hidden-accessible)").each(function(){var a=t(this);a.select2({width:"100%"}),a.trigger("change")}),e.originalFormData=e.getFormData()},100)):(alert(a.data.message||"Error loading task data."),e.modal.dialog("close"))},error:function(){s.css("opacity","1").css("pointer-events","auto"),alert("Error loading task data."),e.modal.dialog("close")}})},openModalForCopy:function(a){var e=this;t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:{action:"pta_sus_get_task",nonce:ptaSusTaskData.nonce,task_id:a},success:function(a){if(a.success&&a.data.task){var s=a.data.task;s.task_id=0,e.modal.dialog("open"),e.resetForm(),e.populateForm(s),e.setModalTitle("Add New Task"),e.hasUnsavedChanges=!1,setTimeout(function(){void 0!==t.fn.select2&&t("#pta-sus-task-modal select.jq-select2:not(.select2-hidden-accessible), #pta-sus-task-modal select[multiple]:not(.select2-hidden-accessible)").each(function(){var a=t(this);a.select2({width:"100%"}),a.trigger("change")}),e.originalFormData=e.getFormData()},100)}else alert(a.data.message||"Error loading task data.")},error:function(){alert("Error loading task data.")}})},populateForm:function(e){t("#task_id").val(e.task_id||0),t("#task_title").val(e.task_title||"");var s=t("#task_dates");s.length&&(s.val(e.task_dates||""),e.task_has_signups&&"Multi-Day"===this.sheetType?(s.prop("readonly",!0),0===s.closest("tr").find(".date-signup-warning").length&&s.after('<span class="date-signup-warning" style="color: #d63638; margin-left: 10px;"><em>This date cannot be changed because there are signups for this task on this date. Please clear signups first.</em></span>')):(s.prop("readonly",!1),s.siblings(".date-signup-warning").remove()));t("#task_qty").val(e.task_qty||1),t("#task_time_start").val(e.task_time_start||""),t("#task_time_end").val(e.task_time_end||""),t("#task_allow_duplicates").prop("checked","YES"===e.task_allow_duplicates),t("#task_enable_quantities").prop("checked","YES"===e.task_enable_quantities),t("#task_need_details").prop("checked","YES"===e.task_need_details),t("#task_details_required").prop("checked","YES"===e.task_details_required),t("#task_details_text").val(e.task_details_text||"Item you are bringing");var i=e.task_description||"",n=t("#task_description-quill-container");if(t("#task_description").val(i),n.data("quill-instance")||this.initQuillEditor(),h=n.data("quill-instance"))if(i){var l=h.clipboard.convert({html:i});h.setContents(l,"silent")}else h.setContents([],"silent");t("#task_confirmation_email_template_id").val(e.task_confirmation_email_template_id||0),t("#task_reminder1_email_template_id").val(e.task_reminder1_email_template_id||0),t("#task_reminder2_email_template_id").val(e.task_reminder2_email_template_id||0),t("#task_clear_email_template_id").val(e.task_clear_email_template_id||0),t("#task_reschedule_email_template_id").val(e.task_reschedule_email_template_id||0);var o=["task_id","task_title","task_description","task_dates","task_qty","task_time_start","task_time_end","task_allow_duplicates","task_enable_quantities","task_need_details","task_details_required","task_details_text","task_confirmation_email_template_id","task_reminder1_email_template_id","task_reminder2_email_template_id","task_clear_email_template_id","task_reschedule_email_template_id"];for(var r in e)if(e.hasOwnProperty(r)&&0===r.indexOf("task_")&&-1===o.indexOf(r)){for(var d=e[r],c=["#"+r.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),'[name="'+r+'[0]"]','[name="'+r+'"]',"#"+r],u=null,p=0;p<c.length&&!(u=t(c[p])).length;p++);if(u&&u.length){var h,k=u.closest("td").find("#"+r+"-quill-container");if(k.length)if(h=k.data("quill-instance")){if(d){l=h.clipboard.convert({html:d});h.setContents(l,"silent")}else h.setContents([],"silent");u.val(d||"")}else u.val(d||""),setTimeout(function(){a.initCustomFieldsQuillEditors(),void 0!==t.fn.select2&&t("#pta-sus-task-modal select.jq-select2:not(.select2-hidden-accessible), #pta-sus-task-modal select[multiple]:not(.select2-hidden-accessible)").select2({width:"100%"})},100);else if(u.is("select[multiple]")){var g=[];d&&("string"==typeof d?g=d.split(",").map(function(t){return t.trim()}).filter(function(t){return""!==t}):Array.isArray(d)&&(g=d)),u.val(g).trigger("change"),void 0===t.fn.select2||u.hasClass("select2-hidden-accessible")||u.select2({width:"100%"})}else u.is("select")?(u.val(d||"").trigger("change"),void 0!==t.fn.select2&&u.hasClass("jq-select2")&&!u.hasClass("select2-hidden-accessible")&&u.select2({width:"100%"})):u.is('input[type="checkbox"]')||u.is('input[type="radio"]')?u.prop("checked","YES"===d||"1"===d||!0===d||"on"===d):u.val(d||"")}}"YES"===e.task_need_details?t("#pta-sus-task-modal .pta_toggle").show():t("#pta-sus-task-modal .pta_toggle").hide(),this.initFormPlugins()},resetForm:function(){t("#pta-sus-task-form")[0].reset(),t("#task_id").val(0),t("#task_qty").val(1),t("#task_details_text").val("Item you are bringing"),t("#task_need_details, #task_details_required, #task_allow_duplicates, #task_enable_quantities").prop("checked",!1),t("#pta-sus-task-modal .pta_toggle").hide();var a=t("#task_description-quill-container");t("#task_description").val("");var e=a.data("quill-instance");e&&e.setContents([],"silent"),t('#pta-sus-task-modal select[id^="task_"][id$="_email_template_id"]').val(0);var s=["task_id","task_title","task_description","task_dates","task_qty","task_time_start","task_time_end","task_allow_duplicates","task_enable_quantities","task_need_details","task_details_required","task_details_text","task_confirmation_email_template_id","task_reminder1_email_template_id","task_reminder2_email_template_id","task_clear_email_template_id","task_reschedule_email_template_id","task_sheet_id","task_sheet_type","task_no_signups"];t('#pta-sus-task-modal [id^="task_"], #pta-sus-task-modal [name^="task_"]').each(function(){var a=t(this),e=a.attr("id")||"",i=a.attr("name")||"",n=e.replace(/\[.*?\]/g,""),l=i.replace(/\[.*?\]/g,"");-1===s.indexOf(n)&&-1===s.indexOf(l)&&(a.is('input[type="checkbox"]')||a.is('input[type="radio"]')?a.prop("checked",!1):(a.is("select"),a.val("")))})},getFormData:function(){var a="",e=t("#task_description-quill-container"),s=t("#task_description"),i=e.data("quill-instance");i&&i.root?(a=i.root.innerHTML,s.val(a)):a=s.val();var n=t("#pta-sus-task-form").serialize(),l=[];return t("#task_allow_duplicates").is(":checked")||l.push("task_allow_duplicates=NO"),t("#task_enable_quantities").is(":checked")||l.push("task_enable_quantities=NO"),t("#task_need_details").is(":checked")||l.push("task_need_details=NO"),t("#task_details_required").is(":checked")||l.push("task_details_required=NO"),l.length>0&&(n+=(n?"&":"")+l.join("&")),{queryString:n,description:a}},saveTask:function(){var a=this,e=t("#task_description-quill-container");if(e.length&&"undefined"!=typeof Quill){var s=e.data("quill-instance");s&&s.root&&t("#task_description").val(s.root.innerHTML)}t("#pta-sus-task-modal .pta-quill-container").each(function(){var a=t(this),e=a.attr("id");if("task_description-quill-container"!==e&&e&&-1!==e.indexOf("-quill-container")){var s=e.replace("-quill-container",""),i=t("#"+s);if(i.length){var n=a.data("quill-instance");n&&n.root&&i.val(n.root.innerHTML)}}}),t("#pta-sus-task-modal .pta-quill-container").each(function(){var a=t(this),e=a.attr("id");if("task_description-quill-container"!==e&&e&&-1!==e.indexOf("-quill-container")){var s=e.replace("-quill-container",""),i=t("#"+s);if(i.length){var n=a.data("quill-instance");n&&n.root&&i.val(n.root.innerHTML)}}});var i=t("#task_title").val();if(i&&""!==i.trim()){var n=this.getFormData().queryString||"",l=[];if(l.push("task_sheet_id="+encodeURIComponent(this.sheetId)),l.push("task_sheet_type="+encodeURIComponent(this.sheetType)),l.push("task_no_signups="+(this.noSignups?1:0)),l.push("action=pta_sus_save_task"),l.push("nonce="+encodeURIComponent(ptaSusTaskData.nonce)),"Single"===this.sheetType||"Ongoing"===this.sheetType){var o=t("#single_date").val();o&&l.push("single_date="+encodeURIComponent(o))}else if("Recurring"===this.sheetType){var r=t("#multi999Picker").val();r&&l.push("recurring_dates="+encodeURIComponent(r))}n?n+="&"+l.join("&"):n=l.join("&"),t("#pta-sus-task-save").prop("disabled",!0).text("Saving..."),t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:n,processData:!1,contentType:"application/x-www-form-urlencoded; charset=UTF-8",success:function(e){if(e.success){if(a.hasUnsavedChanges=!1,a.closeModal(),e.data&&e.data.message&&a.showAjaxMessage(e.data.message,"success"),e.data.task_id)if(e.data.task&&"created"===e.data.action){var s=t("#pta-sus-task-list-body");s.find(".pta-sus-no-tasks-row").remove(),t(".pta-sus-task-list").show();var i=a.buildTaskRow(e.data.task);s.append(i),a.initDragDrop()}else if(e.data.task&&"updated"===e.data.action){var n=t('#pta-sus-task-list-body tr[data-task-id="'+e.data.task_id+'"]');if(n.length){var l=a.buildTaskRow(e.data.task);n.replaceWith(l),a.initDragDrop()}else a.addTaskToTable(e.data.task_id)}else"created"===e.data.action?a.addTaskToTable(e.data.task_id):a.updateTaskInTable(e.data.task_id)}else{if(e.data.message){var o=t("#pta-sus-task-modal"),r=o.find(".pta-sus-task-messages");0===r.length&&(r=t('<div class="pta-sus-task-messages"></div>'),o.find("form").prepend(r)),r.html(e.data.message).show(),o.scrollTop(0)}else alert("Error saving task.");t("#pta-sus-task-save").prop("disabled",!1).text("Save & Close")}},error:function(){alert("Error saving task."),t("#pta-sus-task-save").prop("disabled",!1).text("Save & Close")}})}else alert("Task title is required.")},deleteTask:function(a){if(confirm("Are you sure you want to delete this task?")){var e=this;t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:{action:"pta_sus_delete_task",nonce:ptaSusTaskData.nonce,task_id:a},success:function(s){if(s.success){s.data&&s.data.message&&e.showAjaxMessage(s.data.message,"success"),t('#pta-sus-task-list-body tr[data-task-id="'+a+'"]').remove();var i=t("#pta-sus-task-list-body");if(0===i.find("tr").length){var n=6;"Multi-Day"===e.sheetType&&n++,e.noSignups||n++;var l='<tr class="pta-sus-no-tasks-row"><td colspan="'+n+'" class="pta-sus-no-tasks" style="text-align: center; padding: 20px; color: #666;">No tasks have been created yet. Click "Add New Task" to get started.</td></tr>';i.html(l)}}else s.data&&s.data.message?e.showAjaxMessage(s.data.message,"error"):alert("Error deleting task.")},error:function(){alert("Error deleting task.")}})}},saveTaskOrder:function(){var a=this,e=[];t("#pta-sus-task-list-body tr").each(function(a){var s=t(this).data("task-id");s&&(e[a]=s)}),t("#pta-sus-save-order").prop("disabled",!0).text("Saving..."),t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:{action:"pta_sus_reorder_tasks",nonce:ptaSusTaskData.nonce,sheet_id:this.sheetId,task_order:e},success:function(e){t("#pta-sus-save-order").prop("disabled",!1).text("Save Order"),e.success?(t("#pta-sus-save-order-container").hide(),e.data&&e.data.message&&a.showAjaxMessage(e.data.message,"success"),t("#pta-sus-task-list-body tr").each(function(a){t(this).attr("data-position",a)})):(e.data&&e.data.message?a.showAjaxMessage(e.data.message,"error"):alert("Error saving task order."),t("#pta-sus-save-order").prop("disabled",!1).text("Save Order"))},error:function(){alert("Error saving task order."),t("#pta-sus-save-order").prop("disabled",!1).text("Save Order")}})},saveSheetDates:function(){var a=this,e=t("#pta-sus-save-dates");if(!e.prop("disabled")){var s=e.siblings(".spinner"),i=e.data("sheet-id"),n=e.data("sheet-type");if("Single"===n)if(t("#single_date").val()===this.originalDates.single)return;if(!(this.modal&&this.modal.dialog("isOpen")&&this.hasUnsavedChanges)||confirm("You have unsaved changes in the task form. The dates will be saved, but you may want to save your task first. Continue saving dates?")){var l={action:"pta_sus_save_sheet_dates",nonce:ptaSusTaskData.nonce,sheet_id:i,sheet_type:n};if("Single"===n){var o=t("#single_date").val();if(!o)return void a.showAjaxMessage('<div class="error inline"><p><strong>Please select a date.</strong></p></div>',"error");l.single_date=o}else if("Recurring"===n){var r=t("#multi999Picker").val();if(!r)return void a.showAjaxMessage('<div class="error inline"><p><strong>Please select at least two dates.</strong></p></div>',"error");l.recurring_dates=r}else"Ongoing"===n&&(l.recurring_dates="");e.prop("disabled",!0),s.addClass("is-active"),t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:l,success:function(i){if(s.removeClass("is-active"),e.prop("disabled",!1),i.success){if(i.data&&i.data.message&&a.showAjaxMessage(i.data.message,"success"),"Single"===n)ptaSusTaskData.singleDate=l.single_date,a.originalDates.single=l.single_date,t("#single_date").val(l.single_date),(o=t("#single_date").closest("p")).find(".dashicons").remove(),o.find("label").after('<span class="dashicons dashicons-yes-alt" style="color: #46b450; vertical-align: middle; margin-left: 5px;" title="Date is set"></span>');else if("Recurring"===n){var o;ptaSusTaskData.recurringDates=l.recurring_dates,a.originalDates.recurring=l.recurring_dates,t("#multi999Picker").val(l.recurring_dates),(o=t("#multi999Picker").closest("p")).find(".dashicons").remove(),o.find("label").after('<span class="dashicons dashicons-yes-alt" style="color: #46b450; vertical-align: middle; margin-left: 5px;" title="Dates are set"></span>')}a.datesChanged=!1,a.updateDateChangeIndicator(),i.data.tasks_updated>0&&setTimeout(function(){window.location.reload()},1500)}else if(i.data&&i.data.message&&a.showAjaxMessage(i.data.message,"error"),i.data.has_signups&&"Single"===n){t("#single_date").prop("readonly",!0),e.prop("disabled",!0).css("opacity","0.5").css("cursor","not-allowed");var r=t("#single_date");r.data("datepick-initialized")&&(r.datepick("destroy"),r.removeData("datepick-initialized"))}},error:function(){s.removeClass("is-active"),e.prop("disabled",!1),a.showAjaxMessage('<div class="error inline"><p><strong>Error saving dates. Please try again.</strong></p></div>',"error")}})}}},refreshTaskList:function(){window.location.reload()},addTaskToTable:function(a){var e=this;t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:{action:"pta_sus_get_task",nonce:ptaSusTaskData.nonce,task_id:a},success:function(a){if(a.success&&a.data.task){var s=a.data.task,i=t("#pta-sus-task-list-body");i.find(".pta-sus-no-tasks-row").remove(),t(".pta-sus-task-list").show();var n=e.buildTaskRow(s);i.append(n),e.initDragDrop()}},error:function(){e.refreshTaskList()}})},updateTaskInTable:function(a){var e=this;t.ajax({url:ptaSusTaskData.ajaxUrl,type:"POST",data:{action:"pta_sus_get_task",nonce:ptaSusTaskData.nonce,task_id:a},success:function(s){if(s.success&&s.data.task){var i=s.data.task,n=t('#pta-sus-task-list-body tr[data-task-id="'+a+'"]');if(n.length){var l=e.buildTaskRow(i);n.replaceWith(l),e.initDragDrop()}else e.addTaskToTable(a)}},error:function(){e.refreshTaskList()}})},buildTaskRow:function(a){var e=this,s=this.sheetType,i=this.noSignups,n=a.task_time_start||"",l=a.task_time_end||"";function o(t){if(!t)return"";var a=t.split(":");if(a.length<2)return t;var e=parseInt(a[0],10),s=e>=12?"PM":"AM";return 0===(e%=12)&&(e=12),e+":"+a[1]+" "+s}n=o(n),l=o(l);var r="";if(a.task_description){var d=t("<div>").html(a.task_description).text().split(/\s+/);r=d.slice(0,10).join(" "),d.length>10&&(r+="...")}var c='<tr data-task-id="'+a.task_id+'" data-position="'+(a.task_position||0)+'">';return c+='<td class="column-drag"><span class="dashicons dashicons-move" style="cursor: move;"></span></td>',c+='<td class="column-title"><strong>'+e.escapeHtml(a.task_title||"")+"</strong>",r&&(c+="<br/><small>"+e.escapeHtml(r)+"</small>"),c+="</td>","Multi-Day"===s&&(c+='<td class="column-date">'+e.escapeHtml(a.task_dates||"")+"</td>"),i||(c+='<td class="column-qty">'+(a.task_qty||0)+"</td>"),c+='<td class="column-time">'+e.escapeHtml(n)+"</td>",c+='<td class="column-time">'+e.escapeHtml(l)+"</td>",c+='<td class="column-actions">',c+='<button type="button" class="button button-small pta-sus-edit-task" data-task-id="'+a.task_id+'">Edit</button> ',c+='<button type="button" class="button button-small pta-sus-copy-task" data-task-id="'+a.task_id+'">Copy</button> ',c+='<button type="button" class="button button-small pta-sus-delete-task" data-task-id="'+a.task_id+'">Delete</button>',c+="</td>",t(c+="</tr>")},escapeHtml:function(t){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t?t.replace(/[&<>"']/g,function(t){return a[t]}):""},showAjaxMessage:function(a,e){e=e||"success";var s=t(".pta-sus-ajax-messages");0===s.length&&(s=t('<div class="pta-sus-ajax-messages"></div>'),t(".pta-sus-task-management").before(s)),t(a).each(function(){var i=t(this);if(i.hasClass("error")||i.hasClass("updated")||i.hasClass("notice")||(i=i.find(".error, .updated, .notice").first()),i.length&&(i.hasClass("error")||i.hasClass("updated")||i.hasClass("notice"))){var n=t('<div class="pta-sus-ajax-message-wrapper" style="position: relative; margin-bottom: 10px;"></div>');i.css("position","relative").css("padding-right","38px");var l=t('<button type="button" class="notice-dismiss" style="position: absolute; top: 0; right: 1px; border: none; margin: 0; padding: 9px; background: none; cursor: pointer; color: #787c82;"><span class="screen-reader-text">Dismiss this notice.</span></button>');i.append(l),n.append(i),s.append(n).show(),l.on("click",function(a){a.preventDefault(),n.fadeOut(300,function(){t(this).remove(),0===s.find(".pta-sus-ajax-message-wrapper").length&&s.hide()})}),"success"===e&&i.hasClass("updated")&&setTimeout(function(){n.is(":visible")&&n.fadeOut(500,function(){t(this).remove(),0===s.find(".pta-sus-ajax-message-wrapper").length&&s.hide()})},5e3)}else{(n=t('<div class="pta-sus-ajax-message-wrapper" style="margin-bottom: 10px;"></div>')).html(a),s.append(n).show()}}),t("html, body").animate({scrollTop:0},300)},handleModalClose:function(){if(this.hasUnsavedChanges&&!confirm("You have unsaved changes in the task form. Are you sure you want to close without saving?"))return!1;if(this.datesChanged&&("Single"===this.sheetType||"Recurring"===this.sheetType)){var t="Single"===this.sheetType?"date":"dates";if(!confirm("You have unsaved changes to the "+t+". The task form will close, but you should save the "+t+' using the "Save '+("Single"===this.sheetType?"Date":"Dates")+'" button. Continue closing?'))return!1}return!0},closeModal:function(){this.handleModalClose()&&(t("#pta-sus-task-save").prop("disabled",!1).text("Save & Close"),this.modal.dialog("close"),this.hasUnsavedChanges=!1)},setModalTitle:function(a){t("#pta-sus-task-modal-title").text(a)}};t(document).ready(function(){a.init()})}(jQuery);