window.ptaVolunteer={config:{ajaxUrl:"",method:"POST",extraData:{},minSearchLength:2,debounceDelay:300},init(e={}){this.config={...this.config,...e,fieldPrefix:void 0!==e.fieldPrefix?e.fieldPrefix:"signup_",updateUserDropdown:e.updateUserDropdown||!1},document.querySelector('input[name="signup_firstname"], input[name="signup_lastname"], input[name="firstname"], input[name="lastname"]')&&this.setupAutocomplete()},htmlDecode(e){if(!e)return"";const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""},setupAutocomplete(){document.querySelectorAll('input[name="signup_firstname"], input[name="signup_lastname"], input[name="signup_email"], input[name="firstname"], input[name="lastname"], input[name="email"]').forEach(e=>{let t,n;e.addEventListener("input",a=>{const i=a.target.value.trim();clearTimeout(t),n&&n.abort(),i.length<this.config.minSearchLength?this.clearAutocomplete(e):t=setTimeout(async()=>{try{n=new AbortController;const t=await this.fetchResults(i,n.signal);this.renderAutocomplete(t,e)}catch(t){"AbortError"!==t.name&&this.clearAutocomplete(e)}finally{n=null}},this.config.debounceDelay)}),e.addEventListener("blur",()=>{setTimeout(()=>{this.clearAutocomplete(e)},200)})})},async fetchResults(e,t){const n=new FormData;n.append("q",e),n.append("pta_pub_action","autocomplete_volunteer"),n.append("action",this.config.extraData.action),n.append("security",this.config.extraData.security);const a=await fetch(this.config.ajaxUrl,{method:"POST",body:n,signal:t});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=await a.json();return i&&"object"==typeof i&&"success"in i?i.success&&Array.isArray(i.data)?i.data:[]:Array.isArray(i)?i:[]},renderAutocomplete(e,t){let n=t.parentNode.querySelector(".autocomplete-results");if(n||(n=document.createElement("ul"),n.className="autocomplete-results",t.parentNode.appendChild(n)),!e||!Array.isArray(e)||0===e.length)return n.innerHTML="",void(n.style.display="none");n._volunteerData||(n._volunteerData=[]),n._volunteerData=e,n.style.display="block",n.innerHTML=e.map((e,t)=>`\n                <li>\n                    <a href="#" data-index="${t}">\n                        <strong>${this.htmlDecode(e.firstname||"")} ${this.htmlDecode(e.lastname||"")}</strong>\n                        <br>\n                        <small>${this.htmlDecode(e.email||"")}</small>\n                    </a>\n                </li>\n            `).join(""),n.removeEventListener("click",n._clickHandler),n._clickHandler=e=>{e.preventDefault(),e.stopPropagation();const a=e.target.closest("a[data-index]");if(a&&n._volunteerData){const e=parseInt(a.getAttribute("data-index"),10);!isNaN(e)&&n._volunteerData[e]&&(this.populateFields(n._volunteerData[e]),this.clearAutocomplete(t))}},n.addEventListener("click",n._clickHandler)},clearAutocomplete(e){const t=e.parentNode.querySelector(".autocomplete-results");t&&(t.innerHTML="",t.style.display="none",t._volunteerData&&(t._volunteerData=null),t._clickHandler&&(t.removeEventListener("click",t._clickHandler),t._clickHandler=null))},populateFields(e){if(!e||"object"!=typeof e)return;const t=this.config.fieldPrefix||"signup_";if(Object.keys(e).forEach(n=>{if("user_id"===n)return;if(["firstname","lastname","email","phone"].includes(n))return;let a=null;const i=[];t&&i.push(`input[name="${t}${n}"]`,`select[name="${t}${n}"]`,`textarea[name="${t}${n}"]`,`select[name="${t}${n}[]"]`),i.push(`input[name="${n}"]`,`select[name="${n}"]`,`textarea[name="${n}"]`,`select[name="${n}[]"]`);for(const e of i)if(a=document.querySelector(e),a)break;if(a){const t=e[n],i=a.tagName.toLowerCase(),l=a.multiple||-1!==a.name.indexOf("[]");if("select"===i&&l){let e=[];if(Array.isArray(t)?e=t.map(e=>String(e).trim()).filter(e=>e):t&&(e=String(t).split(",").map(e=>e.trim()).filter(e=>e)),"undefined"!=typeof jQuery&&jQuery.fn.select2){const t=jQuery(a),n=()=>{t.data("select2")||t.select2(),t.val(e),t.trigger("change")};n(),t.data("select2")||setTimeout(()=>{n()},100)}else Array.from(a.options).forEach(t=>{const n=String(t.value).trim();t.selected=e.includes(n)}),a.dispatchEvent&&a.dispatchEvent(new Event("change",{bubbles:!0}))}else if("select"===i)a.value=this.htmlDecode(t||""),"undefined"!=typeof jQuery&&jQuery(a).data("select2")?jQuery(a).trigger("change"):a.dispatchEvent&&a.dispatchEvent(new Event("change",{bubbles:!0}));else if("textarea"===i)a.value=this.htmlDecode(t||"");else if("input"===i&&"checkbox"===a.type)a.checked=1==t||!0===t||"1"===t;else if("input"===i&&"radio"===a.type){document.querySelectorAll(`input[type="radio"][name="${a.name}"]`).forEach(e=>{e.checked=e.value===String(t)})}else a.value=this.htmlDecode(t||"");if("input"===i&&a.hasAttribute("data-quill-field")){const e=t||"";a.value=e;const n=a.id+"-quill-container",i=document.getElementById(n);if(i&&"undefined"!=typeof Quill){let t=null;if("undefined"!=typeof jQuery&&(t=jQuery(i).data("quill-instance")),!t&&i.quillInstance&&(t=i.quillInstance),t&&t.root)if(e){const n=t.clipboard.convert({html:e});t.setContents(n,"silent")}else t.setText("");else{if(t=new Quill(i,{theme:"snow",modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic","underline","strike"],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["clean"],["link"]]}}),e){const n=t.clipboard.convert({html:e});t.setContents(n,"silent")}"undefined"!=typeof jQuery?jQuery(i).data("quill-instance",t):i.quillInstance=t,t.on("text-change",function(){const e=t.root.innerHTML;a.value!==e&&(a.value=e)})}}}}}),Object.keys(e).forEach(n=>{if(!["firstname","lastname","email","phone"].includes(n))return;let a=document.querySelector(`input[name="${t}${n}"]`)||document.querySelector(`input[name="${n}"]`);a&&(a.value=this.htmlDecode(e[n]||""))}),"signup_"===t){const t=document.querySelector('input[name="signup_validate_email"]');t&&(t.value=this.htmlDecode(e.email||""));const n=document.querySelector('input[name="signup_user_id"]');if(n&&e.user_id){const t=parseInt(e.user_id||0,10);n.value=t>0?t:""}}if(this.config.updateUserDropdown){const t=document.querySelector('select[name="user_id"]');if(t){const n=parseInt(e.user_id||0,10);if(n>0){const e=t.querySelector(`option[value="${n}"]`);t.value=e?n:"0"}else t.value="0"}}}};